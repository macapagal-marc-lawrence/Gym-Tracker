workflows:
  android-release:
    name: Android Release Build
    instance_type: mac_mini_m2
    environment:
      flutter: stable
      groups:
        - KEYSTORE_CREDENTIALS
      vars:
        PACKAGE_NAME: "com.example.GymTracker"
    scripts:
      - name: Install dependencies
        script: |
          flutter clean
          flutter pub get

      - name: Decode Keystore
        script: |
          echo $CM_KEYSTORE | base64 --decode > /tmp/keystore.jks

      - name: Set up Google Play authentication
        script: |
          echo $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS > /tmp/google-credentials.json

      - name: Configure signing properties
        script: |
          cat <<EOF > android/key.properties
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=/tmp/keystore.jks
          EOF

      - name: Run tests
        script: flutter test

      - name: Build Signed APK
        script: flutter build apk --release

      - name: Build Signed AAB
        script: flutter build appbundle --release

    artifacts:
      - build/app/outputs/flutter-apk/app-release.apk
      - build/app/outputs/bundle/release/app-release.aab

    publishing:
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: beta
        in_app_update_priority: 3
        submit_as_draft: false
